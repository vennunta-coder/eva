<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA AI - Sua Interface de Inteligência Artificial</title>
    <!-- Inclui o Tailwind CSS para estilização moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configurações globais para usar a fonte Inter e cores escuras */
        :root {
            --primary-color: #a855f7; /* Cor principal (roxo/magenta, similar ao Grok) */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0b0f; /* Fundo muito escuro */
        }
        /* Estilo para a animação de carregamento (dots) */
        .loading-dot {
            animation: dot-flicker 1.4s infinite ease-in-out both;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 2px;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes dot-flicker {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        /* Cor de destaque para o texto da IA */
        .ai-text {
            color: #d1d5db; /* Cinza claro */
        }
        /* Estilo do botão de envio */
        #sendButton {
            transition: all 0.2s ease-in-out;
        }
        #sendButton:hover:not(:disabled) {
            transform: scale(1.05);
            background-color: #9333ea;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased text-white">

    <!-- Container Principal do Chat -->
    <div id="chatContainer" class="flex flex-col flex-1 w-full max-w-4xl mx-auto p-4 sm:p-6 md:p-8">
        
        <!-- Cabeçalho (EVA Logo) -->
        <header class="text-center mb-8 pt-4">
            <h1 class="text-6xl sm:text-7xl font-extrabold tracking-tight" style="color: var(--primary-color);">
                EVA
            </h1>
            <p class="text-lg text-gray-500 mt-1">A sua IA não convencional.</p>
        </header>

        <!-- Área de Histórico de Mensagens -->
        <div id="messages" class="flex-1 overflow-y-auto space-y-6 pb-6 scroll-smooth">
            
            <!-- Mensagem de Boas-vindas (similar ao onboarding do Grok) -->
            <div class="flex justify-start">
                <div class="bg-[#1c1c24] p-4 rounded-xl shadow-lg max-w-3xl">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="text-xl font-bold" style="color: var(--primary-color);">EVA</span>
                    </div>
                    <p class="ai-text">
                        Olá! Eu sou a EVA. Pergunte-me qualquer coisa sobre o universo, o futuro ou a melhor receita de pizza. Estou pronta para começar a conversa.
                    </p>
                </div>
            </div>

        </div>

        <!-- Fim da Área de Histórico -->

        <!-- Área de Entrada do Prompt (Fixa na parte inferior) -->
        <div class="sticky bottom-0 bg-[#0b0b0f] pt-4 pb-4">
            <div class="flex items-center bg-[#1c1c24] rounded-2xl p-2 border border-gray-700 focus-within:border-[var(--primary-color)] transition-colors duration-200 shadow-xl">
                
                <input 
                    type="text" 
                    id="promptInput" 
                    placeholder="Pergunte algo à EVA..." 
                    class="flex-1 bg-transparent text-lg text-white p-3 focus:outline-none placeholder-gray-500 rounded-l-xl"
                    aria-label="Introduza a sua pergunta ou comando"
                >

                <!-- Botão de Envio -->
                <button 
                    id="sendButton" 
                    class="bg-[var(--primary-color)] text-white p-3 rounded-xl ml-2 shadow-lg shadow-[var(--primary-color)]/50 disabled:bg-gray-600 disabled:shadow-none"
                    aria-label="Enviar prompt"
                    disabled
                >
                    <!-- Ícone de seta para enviar (SVG) -->
                    <svg id="sendIcon" class="w-6 h-6 transform rotate-45 -mt-1 -mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                    <!-- Ícone de Carregamento (Hidden by default) -->
                    <div id="loadingDots" class="hidden flex justify-center items-center w-6 h-6">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // Definição das variáveis de UI
        const promptInput = document.getElementById('promptInput');
        const sendButton = document.getElementById('sendButton');
        const messagesContainer = document.getElementById('messages');
        const loadingDots = document.getElementById('loadingDots');
        const sendIcon = document.getElementById('sendIcon');
        
        // A API Key é injetada automaticamente. Usamos apenas a URL base.
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`;

        // Utility para scrollar automaticamente para o fundo
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- FUNCIONALIDADE DE COPIAR ---
        /**
         * Copia o texto para a área de transferência usando document.execCommand('copy').
         * @param {string} text - O texto a ser copiado.
         * @param {HTMLElement} buttonElement - O botão que acionou a cópia para feedback visual.
         */
        function copyTextToClipboard(text, buttonElement) {
            const originalIcon = buttonElement.innerHTML;
            const tempTextArea = document.createElement('textarea');
            // Remove espaços em branco em excesso no início/fim
            tempTextArea.value = text.trim(); 
            tempTextArea.style.position = 'fixed';
            tempTextArea.style.opacity = '0';
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                // Utiliza execCommand('copy') por compatibilidade em alguns ambientes iframe
                const successful = document.execCommand('copy'); 
                if (successful) {
                    // Feedback visual: Mudar para ícone de checkmark
                    buttonElement.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="green" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
                    setTimeout(() => {
                        // Voltar ao ícone original
                        buttonElement.innerHTML = originalIcon;
                    }, 1500);
                }
            } catch (err) {
                console.error('Falha ao copiar:', err);
            }
            document.body.removeChild(tempTextArea);
        }
        // ---------------------------------

        // Habilita/Desabilita o botão de envio
        promptInput.addEventListener('input', () => {
            sendButton.disabled = promptInput.value.trim() === '';
        });

        // Adiciona um novo balão de mensagem ao chat
        function addMessage(text, isUser = false) {
            const messageDiv = document.createElement('div');
            
            if (isUser) {
                // Mensagem do Utilizador (alinhada à direita)
                messageDiv.className = 'flex justify-end';
                messageDiv.innerHTML = `
                    <div class="bg-indigo-600 p-4 rounded-xl shadow-lg max-w-3xl">
                        <div class="flex items-center justify-end space-x-2 mb-2">
                            <span class="text-md font-semibold text-white">Você</span>
                        </div>
                        <p class="text-white whitespace-pre-wrap">${text}</p>
                    </div>
                `;
            } else {
                // Mensagem da EVA (alinhada à esquerda)
                messageDiv.className = 'flex justify-start';
                messageDiv.innerHTML = `
                    <div class="bg-[#1c1c24] p-4 rounded-xl shadow-lg max-w-3xl relative">
                        <div class="flex items-center space-x-2 mb-2">
                            <span class="text-xl font-bold" style="color: var(--primary-color);">EVA</span>
                        </div>
                        <!-- Texto principal da resposta -->
                        <p class="ai-text whitespace-pre-wrap main-response-text">${text}</p>
                        
                        <!-- Botão de Copiar -->
                        <button class="copy-btn absolute top-2 right-2 text-gray-500 hover:text-white p-1 rounded-md transition-colors" aria-label="Copiar resposta">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 002-2h2a2 2 0 002 2"></path></svg>
                        </button>
                    </div>
                `;
            }
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        // Adiciona o balão de carregamento da EVA
        function addLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'evaLoading';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-[#1c1c24] p-4 rounded-xl shadow-lg">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="text-xl font-bold" style="color: var(--primary-color);">EVA</span>
                    </div>
                    <div class="ai-text flex items-center space-x-2">
                        <p>A pensar...</p>
                        <div id="loadingDotsClone" class="flex">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(loadingDiv);
            scrollToBottom();
            return loadingDiv;
        }

        /**
         * Envia o prompt para a API do Gemini com Google Search grounding.
         * Implementa a lógica de backoff exponencial.
         */
        async function fetchAIResponse(userQuery, retries = 3) {
            // Utiliza o Google Search para garantir respostas factuais e atualizadas
            const systemPrompt = "Você é EVA, um modelo de linguagem de IA não convencional. Responda à pergunta de forma útil, concisa e com um toque de humor ou perspicácia, se for apropriado. Utilize informações da pesquisa Google para fundamentar a sua resposta.";
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 && i < retries - 1) {
                        // Implementa backoff exponencial para 429 (Too Many Requests)
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Taxa limitada. Tentando novamente em ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Próxima tentativa
                    } else {
                        // Lança erro para outros status ou última falha de 429
                        let errorBody = await response.text();
                        try {
                           const jsonError = JSON.parse(errorBody);
                           errorBody = jsonError.error?.message || errorBody;
                        } catch (e) {
                           // Ignorar erro de parse, usar o texto
                        }
                        const detail = errorBody.substring(0, 100).replace(/\s+/g, ' ').trim(); 
                        throw new Error(`Erro de API (${response.status}): ${response.statusText} - Detalhe: ${detail}...`);
                    }
                } catch (error) {
                    console.error("Erro na busca da API:", error);
                    if (i === retries - 1) {
                         throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Erro de rede. Tentando novamente em ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("Falha ao obter resposta da EVA após várias tentativas de API.");
        }

        // Processa o evento de envio
        async function handleSend() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            // 1. Limpar e desabilitar UI
            promptInput.value = '';
            sendButton.disabled = true;
            sendIcon.classList.add('hidden');
            loadingDots.classList.remove('hidden');

            // 2. Adicionar mensagem do utilizador
            addMessage(prompt, true);

            // 3. Adicionar estado de carregamento da EVA
            const loadingMessage = addLoadingMessage();
            
            try {
                const result = await fetchAIResponse(prompt);
                
                const candidate = result.candidates?.[0];
                let aiText = "Desculpe, a EVA não conseguiu processar isso agora. Tente novamente mais tarde.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiText = candidate.content.parts[0].text;
                    
                    // Extrair fontes de fundamentação (grounding)
                    const groundingMetadata = candidate.groundingAttributions;
                    if (groundingMetadata) {
                        sources = groundingMetadata
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }

                // 4. Remover mensagem de carregamento
                loadingMessage.remove();

                // 5. Adicionar a resposta da EVA
                const aiResponseDiv = addMessage(aiText, false);

                // --- Adicionar funcionalidade de Copiar (attach listener) ---
                const copyButton = aiResponseDiv.querySelector('.copy-btn');
                const responseTextElement = aiResponseDiv.querySelector('.main-response-text');

                if (copyButton && responseTextElement) {
                    copyButton.addEventListener('click', () => {
                        // O texto a copiar é o texto puro dentro da tag <p>
                        const textToCopy = responseTextElement.textContent; 
                        copyTextToClipboard(textToCopy, copyButton);
                    });
                }
                // ----------------------------------------------------------

                // 6. Adicionar fontes de citação se existirem
                if (sources.length > 0) {
                    const sourceList = sources.map((s, index) => 
                        `<li class="mt-1 text-xs text-gray-500 hover:text-[var(--primary-color)] transition-colors">
                            [${index + 1}] <a href="${s.uri}" target="_blank" rel="noopener noreferrer" class="underline">${s.title}</a>
                        </li>`
                    ).join('');
                    
                    const sourcesHtml = `
                        <div class="mt-2 pt-2 border-t border-gray-700">
                            <p class="text-sm font-semibold text-gray-400">Fontes:</p>
                            <ul class="list-none p-0 m-0">${sourceList}</ul>
                        </div>
                    `;
                    // Inserir as fontes no balão da EVA
                    aiResponseDiv.querySelector('.bg-\\[\\#1c1c24\\]').insertAdjacentHTML('beforeend', sourcesHtml);
                }

            } catch (error) {
                console.error("Erro geral no chat:", error);
                loadingMessage.remove();
                
                const detailedErrorMessage = error.message || "Erro desconhecido. Verifique a consola (F12) para mais detalhes.";
                const userFacingError = `Oops! Encontrei um erro. Por favor, tente novamente. Detalhe: ${detailedErrorMessage}`;
                
                addMessage(userFacingError, false);
            } finally {
                // 7. Reativar UI
                sendButton.disabled = promptInput.value.trim() === '';
                sendIcon.classList.remove('hidden');
                loadingDots.classList.add('hidden');
            }
        }

        // Event Listeners
        sendButton.addEventListener('click', handleSend);
        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                handleSend();
            }
        });

        // Garantir que a área de mensagens começa no fundo
        window.addEventListener('load', scrollToBottom);

    </script>
</body>
</html>

