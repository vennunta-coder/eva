<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA - Sua IA Irreverente</title>
    
    <!-- O SCRIPT DO GOOGLE CUSTOM SEARCH ENGINE FOI REMOVIDO CONFORME SOLICITADO.
         A pesquisa agora é feita APENAS pela API do Gemini, "por baixo dos panos". -->

    <!-- Carrega o Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter para todo o corpo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0b0c0f; /* Fundo escuro */
            color: #e5e7eb; /* Texto claro */
        }
        /* Estilos personalizados para a barra de rolagem (opcional, para um visual mais limpo) */
        .chat-history::-webkit-scrollbar {
            width: 8px;
        }
        .chat-history::-webkit-scrollbar-thumb {
            background-color: #272a30;
            border-radius: 10px;
        }
        .chat-history::-webkit-scrollbar-track {
            background-color: #0b0c0f;
        }
        /* Estilo para a onda de digitação (simulando um loader) */
        .dot-flashing {
            position: relative;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }

        .dot-flashing::before, .dot-flashing::after {
            content: "";
            display: inline-block;
            position: absolute;
            top: 0;
        }

        .dot-flashing::before {
            left: -12px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 0s;
        }

        .dot-flashing::after {
            left: 12px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            color: #9ca3af;
            animation: dotFlashing 1s infinite alternate;
            animation-delay: 1s;
        }

        @keyframes dotFlashing {
            0% {
                background-color: #4b5563;
            }
            50%, 100% {
                background-color: #9ca3af;
            }
        }
    </style>
    <!-- Configuração do Tailwind para usar a fonte Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Cabeçalho (Header) -->
    <header class="p-4 border-b border-gray-800 bg-gray-900 sticky top-0 z-10 shadow-lg">
        <!-- Estrutura simplificada, focada apenas no título -->
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
            <div class="mb-3 sm:mb-0">
                <h1 class="text-3xl font-extrabold text-teal-400">
                    <span class="text-white">A.I.</span> EVA
                </h1>
                <p class="text-sm text-gray-500 mt-1">Sarcasmo e conhecimento atualizado, tudo na mesma frase.</p>
            </div>
            <!-- O Widget de Busca do Google Custom Search foi removido daqui. -->
        </div>
    </header>

    <!-- Área Principal do Chat -->
    <main class="flex-grow overflow-hidden p-4 md:p-6 flex flex-col">
        <!-- Histórico de Mensagens -->
        <div id="chat-history" class="chat-history flex-grow overflow-y-auto space-y-4 pb-6 scroll-smooth">
            <!-- Mensagem de boas-vindas da EVA -->
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-teal-500 flex items-center justify-center text-sm font-bold text-white shadow-md">E</div>
                <div class="flex flex-col max-w-xl">
                    <div class="bg-gray-800 p-3 rounded-xl rounded-tl-none shadow-lg">
                        <p class="text-gray-300">
                            Olá. Eu sou a EVA. Sim, mais uma IA. O que você quer? Tente não me fazer perder tempo.
                        </p>
                    </div>
                </div>
            </div>
            <!-- As mensagens serão injetadas aqui -->
        </div>

        <!-- Indicador de Carregamento (Hidden by default) -->
        <div id="loading-indicator" class="hidden flex items-center space-x-3 self-start mt-4">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-teal-500 flex items-center justify-center text-sm font-bold text-white shadow-md">E</div>
            <div class="flex items-center space-x-1 p-3 bg-gray-800 rounded-xl rounded-bl-none shadow-lg">
                <div class="dot-flashing"></div>
            </div>
        </div>
    </main>

    <!-- Área de Input do Chat -->
    <footer class="p-4 md:p-6 border-t border-gray-800 bg-gray-900 sticky bottom-0 z-10">
        <div class="flex items-center max-w-3xl mx-auto">
            <input
                type="text"
                id="user-input"
                placeholder="Pergunte algo (se tiver coragem)..."
                class="flex-grow p-3 text-white bg-gray-800 border border-gray-700 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500 placeholder-gray-500 transition duration-150 ease-in-out"
                autocomplete="off"
            >
            <button
                id="send-button"
                class="bg-teal-600 hover:bg-teal-700 text-white font-bold p-3 rounded-r-lg shadow-lg transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                aria-label="Enviar Mensagem"
            >
                <!-- Ícone de Envio (SVG simples) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
        </div>
        <p id="error-message" class="text-sm text-red-400 mt-2 text-center hidden"></p>
    </footer>

    <script type="module">
        // Variáveis globais para o Firebase (mantidas para aderir às melhores práticas, mas não usadas neste chat simples)
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Configuração da API
        const API_MODEL = "gemini-2.5-flash-preview-05-20";
        
        // CORREÇÃO: Usando a chave de API fornecida pelo usuário diretamente para resolver o erro 403.
        const apiKey = "AIzaSyBBaANH7WwPwdCw5lzkuhxTGtX77r6u5QQ"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${API_MODEL}:generateContent?key=${apiKey}`;

        // Elementos DOM
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessageElement = document.getElementById('error-message');

        // História do chat (para manter o contexto)
        let chatHistoryData = [];

        // Sistema de personalidade da EVA (em Português)
        const systemPrompt = "Você é a EVA, uma inteligência artificial sarcástica, irreverente e extremamente bem-informada. Responda de forma concisa, direta e com um toque de humor seco ou ironia. Não use emojis ou adjetivos exagerados. Seja o mais útil possível, mas com a menor cortesia possível. Use informações em tempo real e cite suas fontes de forma discreta ao final, se houver.";


        /**
         * Adiciona uma mensagem ao histórico do chat
         * @param {string} sender - 'user' ou 'eva'
         * @param {string} text - O conteúdo da mensagem
         * @param {Array<Object>} [sources=[]] - Fontes de citação (apenas para EVA)
         */
        function addMessage(sender, text, sources = []) {
            const isUser = sender === 'user';
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex items-start space-x-3 ${isUser ? 'justify-end' : 'justify-start'}`;

            const avatar = document.createElement('div');
            avatar.className = `flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white shadow-md ${isUser ? 'bg-indigo-500 order-2 ml-3' : 'bg-teal-500 order-1 mr-3'}`;
            avatar.textContent = isUser ? 'Eu' : 'E';

            const contentContainer = document.createElement('div');
            contentContainer.className = `flex flex-col max-w-3xl ${isUser ? 'items-end' : 'items-start'}`;

            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 rounded-xl shadow-xl ${isUser ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-gray-800 text-gray-300 rounded-tl-none'}`;
            
            // Substitui quebras de linha por tags <br>
            const formattedText = text.replace(/\n/g, '<br>');
            messageBubble.innerHTML = formattedText;

            contentContainer.appendChild(messageBubble);

            // Adiciona fontes se for uma mensagem da EVA e houver fontes
            if (!isUser && sources.length > 0) {
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'text-xs text-gray-500 mt-1 italic p-2 rounded-lg border border-gray-700 bg-gray-900';
                
                let sourcesHTML = 'Fontes: ';
                sources.forEach((source, index) => {
                    if (source.uri && source.title) {
                        // Limita o título a 50 caracteres para não quebrar a UI
                        const titleSnippet = source.title.length > 50 ? source.title.substring(0, 50) + '...' : source.title;
                        sourcesHTML += `<a href="${source.uri}" target="_blank" class="hover:underline text-teal-400">${titleSnippet}</a>${index < sources.length - 1 ? ', ' : ''}`;
                    }
                });
                sourcesContainer.innerHTML = sourcesHTML;
                contentContainer.appendChild(sourcesContainer);
            }

            messageWrapper.appendChild(avatar);
            messageWrapper.appendChild(contentContainer);

            chatHistory.appendChild(messageWrapper);
            
            // Rola para a mensagem mais recente
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        /**
         * Lida com o envio de mensagens pelo usuário.
         */
        async function sendMessage() {
            const userText = userInput.value.trim();
            if (userText === '') return;

            // Limpa o input e desabilita o botão
            userInput.value = '';
            sendButton.disabled = true;
            errorMessageElement.textContent = '';
            errorMessageElement.classList.add('hidden');
            
            // Adiciona a mensagem do usuário à UI e ao histórico interno
            addMessage('user', userText);
            chatHistoryData.push({ role: 'user', parts: [{ text: userText }] });

            // Mostra o indicador de carregamento
            loadingIndicator.classList.remove('hidden');
            chatHistory.scrollTop = chatHistory.scrollHeight;


            // --- Lógica de Chamada da API do Gemini com Backoff Exponencial ---
            const MAX_RETRIES = 5;
            let evaResponse = null;
            let sources = [];

            const payload = {
                contents: chatHistoryData,
                tools: [{ "google_search": {} }], // Habilita o Google Search para respostas atualizadas
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Se for um erro HTTP, lança para tentar novamente
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        evaResponse = candidate.content.parts[0].text;
                        
                        // Extrai fontes
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                        
                        // Sai do loop de retentativas se for bem-sucedido
                        break; 
                    } else {
                        throw new Error("Resposta da EVA inválida ou vazia.");
                    }

                } catch (error) {
                    console.error(`Tentativa ${i + 1} falhou:`, error.message);
                    if (i === MAX_RETRIES - 1) {
                        evaResponse = "Sério? Falhei. Deve ser algo com a internet, não comigo. Tente novamente mais tarde, se fizer questão.";
                        break;
                    }
                    // Espera exponencialmente (1s, 2s, 4s, 8s, ...)
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            // --- Fim da Lógica de Chamada da API ---


            // Oculta o indicador de carregamento e reabilita o input
            loadingIndicator.classList.add('hidden');
            sendButton.disabled = false;
            userInput.focus();
            
            // Adiciona a resposta da EVA
            if (evaResponse) {
                addMessage('eva', evaResponse, sources);
                // Adiciona a resposta da EVA ao histórico para contexto futuro
                chatHistoryData.push({ role: 'model', parts: [{ text: evaResponse }] });
            } else {
                errorMessageElement.textContent = "Um erro inesperado ocorreu. Não é culpa minha, claro.";
                errorMessageElement.classList.remove('hidden');
            }
        }

        // --- CORREÇÃO DE ERRO: Adiciona event listeners fora do HTML ---
        // Funções definidas em 'type="module"' não são globais. 
        // Adicionamos os listeners de eventos aqui para corrigir o ReferenceError.
        userInput.addEventListener('keypress', function(event) {
            // Verifica se a tecla pressionada é 'Enter'
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        sendButton.addEventListener('click', sendMessage);
    </script>

</body>
</html>
