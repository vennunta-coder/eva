<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EVA - Assistente</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"/>
  <style>
    body { background: #f9fafb; font-family: 'Inter', sans-serif; }
    .chat-container { max-width: 900px; margin: 0 auto; height: 90vh; display: flex; flex-direction: column; }
    .messages { flex: 1; overflow-y: auto; padding: 1rem; }
    .msg { display: flex; margin-bottom: 1rem; }
    .msg.user { justify-content: flex-end; }
    .msg.eva { justify-content: flex-start; }
    .bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 70%; }
    .user .bubble { background: #0078FF; color: white; border-bottom-right-radius: 0.25rem; }
    .eva .bubble { background: #e5e7eb; color: #111827; border-bottom-left-radius: 0.25rem; }
    footer { text-align: center; padding: 0.75rem; font-size: 0.9rem; background: #f3f4f6; }
    .eva-logo { width: 32px; height: 32px; border-radius: 50%; margin-right: 0.5rem; }
    .typing span {
      display: inline-block; width: 6px; height: 6px; margin: 0 1px;
      background: #555; border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing span:nth-child(2){ animation-delay:0.2s; }
    .typing span:nth-child(3){ animation-delay:0.4s; }
    @keyframes blink {0%{opacity:.2;}20%{opacity:1;}100%{opacity:.2;}}
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Header -->
    <header class="bg-white shadow p-4 flex items-center">
      <img src="https://raw.githubusercontent.com/vennunta-coder/eva/refs/heads/main/logoeva.png" alt="EVA" class="w-10 h-10 mr-3"/>
      <h1 class="text-2xl font-bold"><span style="color:black">E</span><span style="color:orange">V</span><span style="color:black">A</span></h1>
    </header>

    <!-- Messages -->
    <div id="messages" class="messages">
      <div class="msg eva">
        <img src="https://raw.githubusercontent.com/vennunta-coder/eva/refs/heads/main/logoeva.png" class="eva-logo" alt="EVA"/>
        <div class="bubble">Olá! Eu sou a EVA.<br/>Já vens com choradeira ou com piada?</div>
      </div>
    </div>

    <!-- Input -->
    <div class="p-4 bg-white border-t flex">
      <textarea id="userInput" rows="1" placeholder="Escreve a tua mensagem..." 
        class="flex-1 resize-none border rounded-l-lg p-2"></textarea>
      <button onclick="sendMessage()" 
        class="bg-blue-600 text-white px-4 rounded-r-lg">Enviar</button>
    </div>
  </div>

  <footer>
    <span style="color:black">E</span><span style="color:orange">V</span><span style="color:black">A</span> © 2025
  </footer>

  <script>
    const OPENWEATHER_KEY = "7db838cde261492656dc201d1d17e4aa";
    const GOOGLE_KEY = "AIzaSyD3OOOrDwc5KtuiUAzg1Pq2dGGVaRJjU3s";

    let awaitingCity = false;
    let awaitingYoutubeConfirm = false;
    let awaitingTranslation = false;
    let lastQuery = "";

    function appendMessage(sender, text, isHTML=false) {
      const msgContainer = document.getElementById("messages");
      const msg = document.createElement("div");
      msg.className = "msg " + sender;

      let avatar = "";
      if(sender === "eva") {
        avatar = `<img src="https://raw.githubusercontent.com/vennunta-coder/eva/refs/heads/main/logoeva.png" class="eva-logo" alt="EVA"/>`;
      }

      msg.innerHTML = avatar + `<div class="bubble">${isHTML ? text : text.replace(/\n/g,"<br>")}</div>`;
      msgContainer.appendChild(msg);
      msgContainer.scrollTop = msgContainer.scrollHeight;
    }

    function addTyping() {
      const id = "typing-" + Date.now();
      const chat = document.getElementById("messages");
      const div = document.createElement("div");
      div.id = id; div.className = "msg eva";
      div.innerHTML = `
        <img src="https://raw.githubusercontent.com/vennunta-coder/eva/refs/heads/main/logoeva.png" class="eva-logo"/>
        <div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
      return id;
    }
    function removeTyping(id){const el=document.getElementById(id);if(el)el.remove();}

    async function sendMessage() {
      const input = document.getElementById("userInput");
      const text = input.value.trim();
      if(!text) return;
      appendMessage("user", text);
      input.value = "";

      const typingId = addTyping();

      setTimeout(async () => {
        removeTyping(typingId);
        await processMessage(text);
      }, 1200);
    }

    async function processMessage(text){
      // Estado: cidade pedida
      if(awaitingCity){ awaitingCity=false; return getWeatherByCity(text); }
      // Estado: YouTube
      if(awaitingYoutubeConfirm){ awaitingYoutubeConfirm=false;
        if(text.toLowerCase().includes("sim")) return searchYoutube(lastQuery);
        else return appendMessage("eva","Ok, não procurei no YouTube. Podes perguntar outra coisa.");
      }
      // Estado: tradução
      if(awaitingTranslation){ awaitingTranslation=false;
        const translation=await translateText(text,"en");
        return appendMessage("eva","Tradução: "+translation);
      }

      // Clima
      if(text.toLowerCase().includes("clima")||text.toLowerCase().includes("tempo")){
        const match=text.match(/em ([A-Za-zÀ-ÿ\s]+)/i);
        if(match){return getWeatherByCity(match[1].trim());}
        else{
          if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(
              pos=>getWeatherByCoords(pos.coords.latitude,pos.coords.longitude),
              ()=>{appendMessage("eva","Qual cidade queres saber o clima?"); awaitingCity=true;}
            );
          } else {appendMessage("eva","Qual cidade queres saber o clima?"); awaitingCity=true;}
        } return;
      }

      // Tradução
      if(text.toLowerCase().startsWith("traduz")){
        const match=text.match(/para (\w+)/i);
        let targetLang="en";
        if(match){
          const lang=match[1].toLowerCase();
          if(lang.includes("ingl")) targetLang="en";
          else if(lang.includes("fran")) targetLang="fr";
          else if(lang.includes("espa")) targetLang="es";
          else if(lang.includes("ital")) targetLang="it";
          else if(lang.includes("alem")) targetLang="de";
          else return appendMessage("eva","Não reconheço esse idioma. Usa inglês, francês, espanhol, italiano ou alemão.");
        }
        const phrase=text.replace(/traduz/i,"").replace(/para \w+/i,"").trim();
        if(phrase===""){ appendMessage("eva","O que queres que eu traduza?"); awaitingTranslation=true; }
        else {
          const translation=await translateText(phrase,targetLang);
          appendMessage("eva","Tradução: "+translation);
        }
        return;
      }

      // Erotismo
      if(text.toLowerCase().includes("sexo")||text.toLowerCase().includes("erotismo")||text.toLowerCase().includes("intim")){
        return appendMessage("eva","O tema das relações íntimas faz parte da natureza humana. Pergunta direta, resposta direta 😉");
      }

      // Wikipedia
      lastQuery=text;
      try{
        const resp=await fetch(`https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(text)}`);
        if(resp.ok){
          const data=await resp.json();
          if(data.extract){
            return appendMessage("eva",`${data.extract}<br><a href="${data.content_urls.desktop.page}" target="_blank">[Mais info]</a>`,true);
          } else { appendMessage("eva","Não encontrei nada na Wikipedia. Queres que eu procure no YouTube?"); awaitingYoutubeConfirm=true; return;}
        }
      } catch(e){ appendMessage("eva","Erro ao consultar a Wikipedia. Queres que eu procure no YouTube?"); awaitingYoutubeConfirm=true; return;}

      // fallback
      appendMessage("eva","🤷‍♀️ Não encontrei nada relevante desta vez. Tenta reformular a pergunta.");
    }

    async function getWeatherByCity(city){
      try{
        const resp=await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${OPENWEATHER_KEY}&units=metric&lang=pt`);
        const data=await resp.json();
        if(data.weather){ appendMessage("eva",`Clima em ${city}: ${data.weather[0].description}, ${data.main.temp}°C`);}
        else appendMessage("eva","Não consegui obter o clima dessa cidade.");
      }catch(e){appendMessage("eva","Erro ao consultar o clima.");}
    }

    async function getWeatherByCoords(lat,lon){
      try{
        const resp=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_KEY}&units=metric&lang=pt`);
        const data=await resp.json();
        if(data.weather){ appendMessage("eva",`Clima em ${data.name}: ${data.weather[0].description}, ${data.main.temp}°C`);}
        else appendMessage("eva","Não consegui obter o clima agora.");
      }catch(e){appendMessage("eva","Erro ao consultar o clima.");}
    }

    async function searchYoutube(query){
      try{
        const ytResp=await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&key=${GOOGLE_KEY}&maxResults=1`);
        const ytData=await ytResp.json();
        if(ytData.items&&ytData.items.length>0){
          const video=ytData.items[0]; const videoId=video.id.videoId; const title=video.snippet.title;
          appendMessage("eva",`Encontrei este vídeo que pode ajudar:<br><a href="https://www.youtube.com/watch?v=${videoId}" target="_blank">🎥 ${title}</a>`,true);
        } else appendMessage("eva","Nem no YouTube encontrei algo útil. Queres tentar outra pergunta?");
      }catch(e){appendMessage("eva","Erro ao consultar o YouTube.");}
    }

    async function translateText(text,targetLang){
      try{
        const resp=await fetch(`https://translation.googleapis.com/language/translate/v2?key=${GOOGLE_KEY}`,{
          method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({q:text,target:targetLang})
        });
        const data=await resp.json();
        if(data.data&&data.data.translations&&data.data.translations.length>0){
          return data.data.translations[0].translatedText;
        } else return "Não consegui traduzir agora.";
      }catch(e){return "Erro ao usar a API de tradução.";}
    }
  </script>
</body>
</html>
