<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVA - Assistente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilos EVA bubble */
        .bubble-eva {
            border-radius: 1.5rem;
            border-top-left-radius: 0.5rem;
            background-color: #f1f1f1;
            color: #1c1e21;
        }
        /* Estilos User bubble */
        .bubble-user {
            border-radius: 1.5rem;
            border-top-right-radius: 0.5rem;
            background-color: #0078FF;
            color: white;
        }
        /* Indicador de escrita */
        .typing-indicator span {
            animation: pulse-fade 1.5s infinite;
            display: inline-block;
            width: 8px; height: 8px;
            background-color: #0078FF;
            border-radius: 50%; margin-right: 4px;
        }
        @keyframes pulse-fade {
            0%,100% { opacity: .5 } 50% { opacity: 1 }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- HEADER -->
    <header class="bg-white shadow-sm border-b border-gray-200 flex items-center justify-between px-6 h-16">
        <div class="flex items-center space-x-3">
            <!-- Nota: Usei uma URL de imagem de dom√≠nio p√∫blico/placeholder, j√° que a URL original falha. -->
            <img src="https://placehold.co/40x40/0078FF/ffffff?text=E" onerror="this.src='https://placehold.co/40x40/0078FF/ffffff?text=E'" class="w-10 h-10 rounded-full">
            <span class="text-2xl font-bold">
                <span style="color:black">E</span><span style="color:orange">V</span><span style="color:black">A</span>
            </span>
        </div>
    </header>

    <!-- CHAT CONTAINER -->
    <main class="flex-1 flex flex-col max-w-3xl w-full mx-auto p-4 space-y-4 overflow-y-auto" id="chat-messages">
        <!-- Mensagem de boas-vindas inicial da EVA -->
        <div class="flex justify-start">
            <div class="max-w-[80%] p-3 bubble-eva flex space-x-2">
                <img src="https://placehold.co/24x24/0078FF/ffffff?text=E" onerror="this.src='https://placehold.co/24x24/0078FF/ffffff?text=E'" class="w-6 h-6 rounded-full">
                <p>Ol√°! Eu sou a EVA. üëã<br>J√° vens com choradeira ou com piada?</p>
            </div>
        </div>
    </main>

    <!-- INPUT AREA -->
    <div class="bg-white border-t border-gray-200 p-4 flex items-center space-x-2">
        <textarea id="user-input"
            class="flex-1 resize-none border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            placeholder="Escreve a tua mensagem..." rows="1"></textarea>
        <button id="send-button" class="bg-blue-500 hover:bg-blue-600 text-white rounded-full px-5 py-2 transition duration-150 ease-in-out">Enviar</button>
    </div>

    <!-- FOOTER -->
    <footer class="bg-gray-50 text-center text-sm py-2 border-t">
        <span class="font-bold">
            <span style="color:black">E</span><span style="color:orange">V</span><span style="color:black">A</span>
        </span> ¬© 2025
    </footer>

    <script>
        // A chave API √© deixada vazia. O ambiente Canvas fornecer√° o token de forma segura.
        const apiKey = ""; 

        const chat = document.getElementById("chat-messages");
        const input = document.getElementById("user-input");
        const sendBtn = document.getElementById("send-button");
        const evaAvatarUrl = "https://placehold.co/24x24/0078FF/ffffff?text=E";

        // Fun√ß√µes Utilit√°rias de UI

        /** Adiciona uma nova mensagem ao chat. Suporta HTML no texto. */
        function appendMessage(sender, text) {
            const div = document.createElement("div");
            div.className = "flex " + (sender === "user" ? "justify-end" : "justify-start");

            // Para mensagens da EVA, verificamos se o texto cont√©m HTML (como cita√ß√µes)
            const contentHTML = sender === "user" 
                ? `<p>${text}</p>` 
                : `<img src="${evaAvatarUrl}" onerror="this.src='${evaAvatarUrl}'" class="w-6 h-6 rounded-full"> <div class="flex flex-col"><p>${text}</p></div>`;

            div.innerHTML = `
                <div class="max-w-[80%] p-3 ${sender==="user"?"bubble-user":"bubble-eva"} flex space-x-2 items-start">
                    ${contentHTML}
                </div>`;
            
            chat.appendChild(div);
            // Scroll para a √∫ltima mensagem
            chat.scrollTop = chat.scrollHeight;
        }

        /** Mostra o indicador de que a EVA est√° a escrever. */
        function showTyping() {
            const div = document.createElement("div");
            div.id = "typing";
            div.className = "flex justify-start";
            div.innerHTML = `
                <div class="max-w-[80%] p-3 bubble-eva flex space-x-2">
                    <img src="${evaAvatarUrl}" onerror="this.src='${evaAvatarUrl}'" class="w-6 h-6 rounded-full">
                    <div class="typing-indicator flex mt-1">
                        <span></span><span></span><span></span>
                    </div>
                </div>`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        /** Remove o indicador de escrita. */
        function removeTyping() {
            const typing = document.getElementById("typing");
            if (typing) typing.remove();
        }

        // Fun√ß√µes Espec√≠ficas (Comandos Customizados)

        /** Formata as fontes de pesquisa do Gemini como HTML. */
        function formatSources(sources) {
            if (!sources || sources.length === 0) return '';
            
            const uniqueSources = Array.from(new Set(sources.map(s => s.uri)))
                .map(uri => sources.find(s => s.uri === uri));

            let html = '<div class="mt-2 pt-2 border-t border-gray-300 text-xs text-gray-700">';
            html += 'Fonte(s) consultada(s): ';
            uniqueSources.forEach((source, index) => {
                if (source.uri && source.title) {
                    html += `<a href="${source.uri}" target="_blank" class="underline hover:text-blue-500">${source.title}</a>${index < uniqueSources.length - 1 ? ', ' : ''}`;
                }
            });
            html += '</div>';
            return html;
        }

        /** Comando customizado para o Clima (sem API Key funcional, √© apenas um placeholder). */
        async function getWeather(city) {
            // Nota: Esta fun√ß√£o √© um placeholder. Para funcionar, precisaria de uma chave de API OpenWeather v√°lida.
            return `O Gemini √© melhor para responder ao clima atual. Tenta perguntar: "Qual √© o clima em ${city}?"`;
        }

        /** Comando customizado para Tradu√ß√£o (usando a Google Translate API com a chave do ambiente Canvas). */
        async function translateText(text, targetLang) {
            // O targetLang deve ser um c√≥digo ISO 639-1 (ex: 'en', 'es', 'fr')
            try {
                const url = `https://translation.googleapis.com/language/translate/v2?key=${apiKey}`;
                
                // Nota: Usamos 'fetch' diretamente com a chave do ambiente.
                const resp = await fetch(url, {
                    method: "POST",
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({ q: text, target: targetLang })
                });
                
                if (!resp.ok) throw new Error("Translation API call failed");

                const data = await resp.json();
                return data.data?.translations[0]?.translatedText || "N√£o consegui traduzir. O servi√ßo de tradu√ß√£o pode estar indispon√≠vel.";
            } catch (e) { 
                console.error("Erro na tradu√ß√£o:", e);
                return "Erro ao traduzir. Tenta reformular a frase."; 
            }
        }


        // Integra√ß√£o com a API Gemini

        /** * Chama a API Gemini com grounding para pesquisa.
         * Retorna: { text: string, sources: Array<{uri: string, title: string}> }
         */
        async function getGeminiResponse(userQuery) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const systemPrompt = "Voc√™ √© EVA, uma assistente virtual com personalidade e senso de humor, falando sempre em Portugu√™s (PT-PT). Responda √†s perguntas do utilizador de forma √∫til, concisa e direta. Use emojis. N√£o mencione que est√° a usar uma API ou um modelo de IA. Se precisar de informa√ß√µes em tempo real ou factuais, use a ferramenta de pesquisa.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // Habilitar a pesquisa Google para grounding
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let attempts = 0;
            const maxAttempts = 5;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Lan√ßar erro para acionar a l√≥gica de repeti√ß√£o (backoff)
                        throw new Error(`API error: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;

                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title); // Garantir que as fontes s√£o v√°lidas
                        }

                        return { text, sources };

                    } else {
                        // Resposta inesperada
                        return { text: "Ups, n√£o consegui gerar uma resposta. Tenta de novo!", sources: [] };
                    }

                } catch (error) {
                    attempts++;
                    if (attempts >= maxAttempts) {
                        console.error("Gemini API call failed after multiple retries:", error);
                        return { text: "Ocorreu um erro na rede. N√£o consegui contactar os meus servidores. Tenta mais tarde!", sources: [] };
                    }
                    // Exponential backoff
                    const delay = Math.pow(2, attempts) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // L√≥gica Principal de Processamento de Mensagens

        async function processMessage(text) {
            showTyping();

            // Bloqueio de temas restritos
            if (text.toLowerCase().includes("sexo") || text.toLowerCase().includes("erotismo") || text.toLowerCase().includes("intim")) {
                removeTyping();
                appendMessage("eva", "‚ö†Ô∏è Esse tema n√£o est√° dispon√≠vel aqui. Tenta outro assunto.");
                return;
            }

            // 1. Comando Customizado: Clima (Mantido como um exemplo de ferramenta externa)
            if (text.toLowerCase().includes("clima em")) {
                const city = text.split("clima em")[1].trim();
                const weatherResponse = await getWeather(city); 
                removeTyping();
                appendMessage("eva", weatherResponse);
                return;
            }

            // 2. Comando Customizado: Tradu√ß√£o (Mantido como um exemplo de ferramenta externa)
            if (text.toLowerCase().startsWith("traduz")) {
                const match = text.match(/para (\w+)/i);
                let target = "en";
                
                // Extra√ß√£o do idioma alvo
                if (match) {
                    const lang = match[1].toLowerCase();
                    if (lang.includes("ingl")) target="en";
                    else if (lang.includes("fran")) target="fr";
                    else if (lang.includes("espa")) target="es";
                    else if (lang.includes("ital")) target="it";
                    else if (lang.includes("alem")) target="de";
                    else if (lang.includes("portu")) target="pt"; // Adiciona PT
                    else { removeTyping(); appendMessage("eva","Idioma de destino n√£o suportado."); return; }
                }
                
                // Extra√ß√£o da frase a traduzir
                const phrase = text.replace(/traduz/i,"").replace(/para \w+/i,"").trim();
                if (!phrase) { removeTyping(); appendMessage("eva","O que queres que eu traduza?"); return; }

                const translated = await translateText(phrase,target);
                removeTyping();
                appendMessage("eva",`Tradu√ß√£o: ${translated}`); 
                return;
            }

            // 3. Conversa Geral e Pesquisa (Gemini com Google Search Grounding)
            const geminiResult = await getGeminiResponse(text);
            removeTyping();

            const responseText = geminiResult.text.replace(/\n/g, '<br>'); // Troca quebras de linha por <br> para HTML
            const sourcesHtml = formatSources(geminiResult.sources);

            // Adiciona a resposta da EVA e as cita√ß√µes no chat
            appendMessage("eva", responseText + sourcesHtml);
        }

        // Event Listeners

        /** Envia a mensagem ao clicar no bot√£o. */
        sendBtn.addEventListener("click", () => {
            const text = input.value.trim();
            if (!text) return;
            appendMessage("user", text);
            input.value = "";
            input.style.height = 'auto'; // Reset a altura da textarea
            processMessage(text);
        });

        /** Envia a mensagem ao pressionar Enter (sem Shift). */
        input.addEventListener("keydown", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault(); 
                sendBtn.click();
            }
        });

        /** Ajusta a altura da textarea conforme o conte√∫do. */
        input.addEventListener("input", function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

    </script>
</body>
</html>
