<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EVA - Assistente de IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f0f2f5; }
    .bubble-ai { border-radius: 1.5rem; border-top-left-radius: .5rem; background:#e4e6eb; color:#1c1e21; }
    .bubble-user { border-radius: 1.5rem; border-top-right-radius: .5rem; background:#0078FF; color:white; }
  </style>
</head>
<body class="flex justify-center items-center min-h-screen">

  <!-- Container principal largo -->
  <div class="w-full md:w-4/5 h-screen bg-white flex flex-col shadow-xl rounded-xl overflow-hidden">
    
    <!-- Header -->
    <header class="h-16 bg-white border-b flex items-center px-8 font-bold text-2xl shadow-sm">
      EVA
    </header>
    
    <!-- Área do Chat -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-8 space-y-5">
      <div class="flex justify-start">
        <div class="bubble-ai p-5 text-lg leading-relaxed">
          Olá! Sou a EVA 🎭. Pergunta-me sobre <b>mercados</b>, <b>moedas</b>, <b>criptomoedas</b>, 
          <b>futuros</b>, <b>escola</b> ou pede cálculos.
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="p-5 bg-gray-100 flex items-center border-t">
      <textarea id="user-input" placeholder="Mensagem..." 
        class="flex-1 p-3 rounded-lg border text-lg resize-none h-14"></textarea>
      <button id="send-button" 
        class="ml-4 px-8 py-3 bg-blue-600 text-white rounded-lg text-lg shadow-md hover:bg-blue-700 transition">
        Enviar
      </button>
    </div>
  </div>

<script>
/* === Configuração API === */
const API_KEY_ALPHA = "A3GTH364FWCAJQC8"; // Alpha Vantage
const API_KEY_GEMINI = "AIzaSyBBaANH7WwPwdCw5lzkuhxTGtX77r6u5QQ"; // Gemini

function scrollToBottom() {
  const chat = document.getElementById("chat-messages");
  chat.scrollTop = chat.scrollHeight;
}
function addMessage(sender, text) {
  const chat = document.getElementById("chat-messages");
  const div = document.createElement("div");
  div.className = "flex " + (sender === "user" ? "justify-end" : "justify-start");
  div.innerHTML = `<div class="${sender==="user"?"bubble-user":"bubble-ai"} p-5 text-lg leading-relaxed">${text}</div>`;
  chat.appendChild(div);
  scrollToBottom();
}

/* ===========================
   Wikipedia
=========================== */
async function wikiSummary(topic) {
  const url = `https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`;
  const res = await fetch(url, { headers: { "User-Agent": "EVA-Bot/1.0" } });
  if (!res.ok) return "Não encontrei nada na Wikipedia 📚";
  const data = await res.json();
  return `📖 <b>${data.title}</b><br>${data.extract}<br><a href="${data.content_urls.desktop.page}" target="_blank">Ler mais</a>`;
}

/* ===========================
   Gemini
=========================== */
async function getAiResponse(query, mode="normal") {
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY_GEMINI}`;
  let systemPrompt = "Você é EVA, uma assistente sarcástica e bem-humorada. Responda em português de Portugal.";
  if (mode==="edu") systemPrompt = "Você é EVA, uma professora paciente. Explique o assunto de forma simples e clara.";
  const payload = { contents: [{ parts: [{ text: query }] }], systemInstruction: { parts: [{ text: systemPrompt }] } };
  const res = await fetch(apiUrl, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
  const data = await res.json();
  return data.candidates?.[0]?.content?.parts?.[0]?.text || "Não consegui pensar em nada agora 🤷‍♀️";
}

/* ===========================
   Alpha Vantage - Finanças
=========================== */
async function getMarkets() {
  let sp500 = await getStock("SPY");
  let dax = await getStock("DAX");
  let nikkei = await getStock("N225");
  return `🌍 Mercados:<br>🇺🇸 EUA (S&P500): ${sp500}<br>🇩🇪 Europa (DAX): ${dax}<br>🇯🇵 Ásia (Nikkei): ${nikkei}`;
}
async function getForex(from="USD", to="EUR") {
  const url = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=${from}&to_currency=${to}&apikey=${API_KEY_ALPHA}`;
  const res = await fetch(url);
  const data = await res.json();
  return `💱 ${from}/${to}: ${data["Realtime Currency Exchange Rate"]["5. Exchange Rate"]}`;
}
async function getCrypto(symbol="BTC", market="USD") {
  const url = `https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=${symbol}&to_currency=${market}&apikey=${API_KEY_ALPHA}`;
  const res = await fetch(url);
  const data = await res.json();
  return `🪙 ${symbol}/${market}: ${data["Realtime Currency Exchange Rate"]["5. Exchange Rate"]}`;
}
async function getStock(symbol) {
  const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API_KEY_ALPHA}`;
  const res = await fetch(url);
  const data = await res.json();
  return data["Global Quote"] ? data["Global Quote"]["05. price"] : "N/D";
}

/* ===========================
   Calculadora Escolar
=========================== */
function calcIMC(peso, altura) {
  const imc = peso / (altura*altura);
  let status = imc<18.5?"Abaixo do peso":imc<25?"Normal":imc<30?"Sobrepeso":"Obesidade";
  return `🧮 IMC = ${imc.toFixed(2)} (${status})`;
}
function calcJurosCompostos(c, i, t) {
  const montante = c * Math.pow(1 + i/100, t);
  return `📈 Juros Compostos: Capital ${c}, taxa ${i}%, tempo ${t} → Montante = ${montante.toFixed(2)}`;
}
function calcPercentagem(valor, total) {
  return `📊 ${valor} é ${(valor/total*100).toFixed(2)}% de ${total}`;
}
function calcExpressao(expr) {
  try {
    const result = Function('"use strict";return (' + expr + ')')();
    return `🧮 ${expr} = ${result}`;
  } catch { return "Expressão inválida"; }
}

/* ===========================
   Processar comandos
=========================== */
async function handleCommand(query) {
  const q = query.toLowerCase();

  // Finanças
  if (q.includes("mercado")) return await getMarkets();
  if (q.includes("usd") || q.includes("eur") || q.includes("brl")) return await getForex("USD","EUR");
  if (q.includes("bitcoin") || q.includes("btc")) return await getCrypto("BTC","USD");
  if (q.includes("ouro")) return await getStock("GC=F");

  // Escolar: Wikipedia e explicações
  if (q.startsWith("resumo:")) return await wikiSummary(q.replace("resumo:","").trim());
  if (q.startsWith("explica:")) return await getAiResponse(q.replace("explica:","").trim(), "edu");
  if (q.startsWith("wikipedia:") || q.startsWith("quem foi") || q.startsWith("o que é")) 
    return await wikiSummary(q.replace(/wikipedia:|quem foi|o que é/gi,"").trim());

  // Calculadora escolar
  if (q.startsWith("imc")) {
    let peso = parseFloat(q.match(/peso=(\d+(\.\d+)?)/)?.[1]);
    let altura = parseFloat(q.match(/altura=(\d+(\.\d+)?)/)?.[1]);
    return calcIMC(peso, altura);
  }
  if (q.includes("juros compostos")) {
    let c = parseFloat(q.match(/capital=(\d+)/)?.[1]);
    let i = parseFloat(q.match(/taxa=(\d+(\.\d+)?)/)?.[1]);
    let t = parseInt(q.match(/tempo=(\d+)/)?.[1]);
    return calcJurosCompostos(c,i,t);
  }
  if (q.includes("percentagem")) {
    let nums = q.match(/(\d+(\.\d+)?)/g);
    if(nums && nums.length>=2) return calcPercentagem(parseFloat(nums[0]), parseFloat(nums[1]));
  }
  if (q.startsWith("calcular")) {
    return calcExpressao(q.replace("calcular","").trim());
  }

  // Geral (Gemini)
  return await getAiResponse(query);
}

/* ===========================
   Chat
=========================== */
document.getElementById("send-button").addEventListener("click", async () => {
  const input = document.getElementById("user-input");
  const text = input.value.trim();
  if (!text) return;
  addMessage("user", text);
  input.value = "";

  const reply = await handleCommand(text);
  addMessage("ai", reply);
});
</script>
</body>
</html>
