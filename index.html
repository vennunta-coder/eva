<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat com EVA (Powered by Gemini)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Configura√ß√£o do Tailwind CSS
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    /* Importa a fonte Inter para um visual moderno */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
    body { 
        background: #f3f4f6; 
        font-family: 'Inter', sans-serif;
    }
    /* Cont√™iner principal, responsivo e centralizado */
    .chat-container { 
        width: 95%; 
        max-width: 600px; 
        margin: 1rem auto; 
        background: white; 
        border-radius: 12px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 2rem); /* Ocupa a altura da tela no mobile */
    }
    /* √Årea de exibi√ß√£o do chat */
    #chat {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        min-height: 400px; 
    }
    /* Estilo b√°sico de todas as mensagens */
    .msg { 
        padding: 10px 15px; 
        margin: 10px 0;
        border-radius: 10px; 
        max-width: 85%; 
        line-height: 1.5;
        font-size: 0.95rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        word-wrap: break-word;
    }
    /* Estilo para mensagens do usu√°rio (verde, alinhado √† direita) */
    .user { 
        background: #22c55e; 
        color: white; 
        margin-left: auto; 
        border-bottom-right-radius: 2px;
    }
    /* Estilo para mensagens da EVA (cinza claro, alinhado √† esquerda) */
    .eva { 
        background: #f0f0f0; 
        color: #111; 
        margin-right: auto;
        display: flex; 
        align-items: flex-start;
        border-bottom-left-radius: 2px;
    }
    /* √çcone da EVA */
    .eva img { 
        width: 20px; 
        height: 20px; 
        min-width: 20px;
        margin-right: 8px; 
        border-radius: 50%; 
        object-fit: cover;
        margin-top: 2px;
    }
    /* Anima√ß√£o de carregamento (dots) */
    .loading-dot {
        width: 8px;
        height: 8px;
        background-color: #4CAF50;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: loading 1.4s infinite ease-in-out both;
    }
    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }
    .loading-dot:nth-child(3) { animation-delay: 0s; }
    @keyframes loading {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1.0); }
    }
    /* Estilo para links de fonte de cita√ß√£o */
    .source-link {
        color: #1d4ed8;
        text-decoration: underline;
        font-size: 0.8rem;
        margin-top: 5px;
        display: block;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <!-- Cabe√ßalho do Chat -->
    <div class="p-4 border-b text-xl font-bold text-gray-800">Chat com <span class="text-green-600">EVA</span></div>
    
    <!-- √Årea de Mensagens -->
    <div id="chat" class="flex flex-col">
      <div class="msg eva">
        <img src="https://raw.githubusercontent.com/vennunta-coder/eva/refs/heads/main/logoeva.png" alt="EVA"> 
        Ol√°! Eu sou a EVA, agora alimentada pela intelig√™ncia do Gemini. 
        Pergunte-me algo, e eu uso a pesquisa do Google para te dar a melhor resposta! üå∏
      </div>
    </div>
    
    <!-- √Årea de Input e Envio -->
    <div class="p-4 border-t flex items-center bg-gray-50 rounded-b-xl">
      <input 
        id="input" 
        type="text" 
        placeholder="Digite sua mensagem ou pergunta..." 
        class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500 text-base" 
        onkeydown="if(event.key === 'Enter') sendMsg()"
      >
      <button 
        id="send-btn" 
        onclick="sendMsg()" 
        class="ml-3 bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition duration-200 shadow-md active:shadow-none"
      >
        Enviar
      </button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendButton = document.getElementById("send-btn");

    // Configura√ß√£o do Gemini
    const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
    const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=`;
    
    // CHAVE DA API INSERIDA DIRETAMENTE PARA CORRIGIR O ERRO 403
    const apiKey = "AIzaSyCgrM8KySmSgFmi3kBglL42C2Wt8wEocz0"; 
    const apiUrl = API_URL_BASE + apiKey;

    // Vari√°vel para rastrear o estado de carregamento
    let isLoading = false;

    /**
     * Adiciona uma mensagem ao chat.
     * @param {string} text - O conte√∫do da mensagem (pode conter HTML).
     * @param {string} sender - 'user' ou 'eva'.
     */
    function addMessage(text, sender = "eva") {
      const msg = document.createElement("div");
      msg.className = "msg " + sender;

      if (sender === "eva") {
        msg.innerHTML = `<img src="https://raw.githubusercontent.com/vennunta-coder/eva/refs/heads/main/logoeva.png" alt="EVA"> ${text}`;
      } else {
        msg.textContent = text;
      }
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight; // Rola para a mensagem mais recente
    }

    /**
     * Exibe o indicador de carregamento (dots).
     * @returns {HTMLElement} O elemento de mensagem de carregamento.
     */
    function showLoadingIndicator() {
      const loadingMsg = document.createElement("div");
      loadingMsg.className = "msg eva loading-indicator";
      loadingMsg.innerHTML = `<img src="https://raw.githubusercontent.com/vennunta-coder/eva/refs/heads/main/logoeva.png" alt="EVA"> 
        <span>
          <span class="loading-dot"></span>
          <span class="loading-dot"></span>
          <span class="loading-dot"></span>
        </span>`;
      chat.appendChild(loadingMsg);
      chat.scrollTop = chat.scrollHeight;
      return loadingMsg;
    }

    /**
     * Habilita/Desabilita a UI durante o carregamento.
     * @param {boolean} state - true para carregar, false para pronto.
     */
    function setUILoading(state) {
        isLoading = state;
        input.disabled = state;
        sendButton.disabled = state;
        sendButton.textContent = state ? "Processando..." : "Enviar";
        sendButton.classList.toggle('opacity-60', state);
        sendButton.classList.toggle('cursor-not-allowed', state);
    }

    /**
     * Chama a API do Gemini para gerar conte√∫do com Google Search grounding e retries.
     * @param {string} query - O prompt do usu√°rio.
     * @returns {Promise<string>} O texto formatado da resposta (incluindo fontes).
     */
    async function callGemini(query) {
      // Instru√ß√£o do sistema para garantir respostas em portugu√™s e uso do Grounding
      const systemPrompt = "Voc√™ √© a EVA, uma assistente virtual amig√°vel, atenciosa e prestativa. Responda a todas as perguntas em portugu√™s de forma clara e concisa. Sempre use o Google Search para obter informa√ß√µes atualizadas e inclua as cita√ß√µes das fontes no final da sua resposta, usando a formata√ß√£o [N].";

      const payload = {
        contents: [{ parts: [{ text: query }] }],
        tools: [{ "google_search": {} }], // Habilita o Grounding com Google Search
        systemInstruction: {
          parts: [{ text: systemPrompt }]
        },
      };

      let delay = 1000;
      const maxRetries = 3;

      for (let i = 0; i < maxRetries; i++) {
        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          // Lidar com erro HTTP (como 429 - Rate Limit)
          if (!response.ok) {
            console.error(`Erro na tentativa ${i + 1}/${maxRetries}. Status HTTP: ${response.status}. URL: ${apiUrl}`); // Loga o status do erro
            if (response.status === 429 && i < maxRetries - 1) {
                // Tenta novamente com backoff
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
                continue; 
            }
            // Para outros erros (400, 403, 500, etc.), lan√ßa o erro para o bloco catch final
            throw new Error(`Erro HTTP: ${response.status}`);
          }

          const result = await response.json();
          const candidate = result.candidates?.[0];

          if (candidate && candidate.content?.parts?.[0]?.text) {
            let text = candidate.content.parts[0].text;
            let sources = [];
            const groundingMetadata = candidate.groundingMetadata;

            if (groundingMetadata && groundingMetadata.groundingAttributions) {
              sources = groundingMetadata.groundingAttributions
                .map(attribution => ({
                  uri: attribution.web?.uri,
                  title: attribution.web?.title,
                }))
                .filter(source => source.uri && source.title);
            }

            // Formata√ß√£o das fontes para exibi√ß√£o na mensagem
            let sourceHtml = '';
            if (sources.length > 0) {
                sourceHtml += '<div class="mt-3 pt-2 border-t border-gray-200">';
                sources.forEach((source, index) => {
                    sourceHtml += `<a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="source-link">
                        [${index + 1}] ${source.title}
                    </a>`;
                });
                sourceHtml += '</div>';
            }

            return text + sourceHtml;

          } else {
            return "Desculpe, n√£o consegui gerar uma resposta. O resultado do modelo estava vazio. üòî";
          }

        } catch (error) {
          console.error(`Erro na tentativa ${i + 1}/${maxRetries} (Exception):`, error);
          if (i === maxRetries - 1) {
            // Se for o √∫ltimo retry, retorna a mensagem de erro final.
            return `Desculpe, ocorreu um erro de comunica√ß√£o com o servidor ap√≥s ${maxRetries} tentativas. Por favor, verifique o console para mais detalhes sobre o status do erro. üõ†Ô∏è`;
          }
          // Espera e tenta novamente
          await new Promise(resolve => setTimeout(resolve, delay));
          delay *= 2;
        }
      }
      return "Um erro inesperado ocorreu. üõë";
    }

    /**
     * Fun√ß√£o principal para envio de mensagens.
     */
    async function sendMsg() {
      if (isLoading) return; // Impede envios m√∫ltiplos

      const text = input.value.trim();
      if (!text) return;
      
      // 1. Mostrar mensagem do usu√°rio
      addMessage(text, "user");
      input.value = "";
      
      // 2. Mostrar loading e desabilitar UI
      const loadingIndicator = showLoadingIndicator();
      setUILoading(true);

      try {
        // 3. Chamar a API Gemini (com Grounding)
        const resposta = await callGemini(text);

        // 4. Remover loading e adicionar resposta
        chat.removeChild(loadingIndicator);
        addMessage(resposta);
      } catch (error) {
        // Garantir que o loading seja removido em caso de erro
        if (chat.contains(loadingIndicator)) {
            chat.removeChild(loadingIndicator);
        }
        addMessage("‚ö†Ô∏è Ocorreu um erro ao processar sua solicita√ß√£o.", "eva");
        console.error("Erro fatal no sendMsg:", error);
      } finally {
        // 5. Reabilitar UI
        setUILoading(false);
      }
    }
  </script>
</body>
</html>
