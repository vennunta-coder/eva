<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EVA - Assistente de IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    body { background: #f0f2f5; }
    .bubble-ai { border-radius: 1.5rem; border-top-left-radius: 0.5rem; background: #e4e6eb; color: #1c1e21; }
    .bubble-user { border-radius: 1.5rem; border-top-right-radius: 0.5rem; background: #0078FF; color: white; }
  </style>
</head>
<body class="flex justify-center items-center min-h-screen">
  <div class="w-full max-w-3xl h-screen md:h-[90vh] bg-white rounded-none md:rounded-3xl shadow-xl flex flex-col overflow-hidden">
    
    <!-- Header -->
    <header class="h-16 bg-white border-b border-gray-200 flex items-center px-4 shadow-sm">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 flex items-center justify-center text-white">
          EVA
        </div>
        <span class="font-bold text-lg">Assistente EVA</span>
      </div>
    </header>

    <!-- Chat -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col space-y-3">
      <div class="flex justify-start">
        <div class="max-w-[85%] p-3 bubble-ai">
          <p>Ol√°. Sou a EVA üé≠. J√° vens com choradeira ou com piada?</p>
        </div>
      </div>
    </div>

    <!-- Input -->
    <div class="p-3 bg-white border-t border-gray-200 flex items-center space-x-2">
      <textarea id="user-input" class="flex-1 resize-none bg-gray-100 rounded-full px-4 py-2 h-10" placeholder="Mensagem..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}"></textarea>
      <button id="send-button" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-full">Enviar</button>
    </div>
  </div>

<script>
/* ===========================
   Configura√ß√£o Spotify
=========================== */
const SPOTIFY_CLIENT_ID = "09a366bc19514cd89621fd065766f6e5";
const SPOTIFY_CLIENT_SECRET = "e50cba0478f543bb938dbf4bed99ec16";
let spotifyToken = null;

async function getSpotifyToken() {
  if (spotifyToken) return spotifyToken;
  const result = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
      "Authorization": "Basic " + btoa(SPOTIFY_CLIENT_ID + ":" + SPOTIFY_CLIENT_SECRET),
    },
    body: "grant_type=client_credentials"
  });
  const data = await result.json();
  spotifyToken = data.access_token;
  setTimeout(() => spotifyToken = null, (data.expires_in - 60) * 1000);
  return spotifyToken;
}

async function searchSpotifyTrack(query) {
  const token = await getSpotifyToken();
  const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=1`, {
    headers: { "Authorization": "Bearer " + token }
  });
  const data = await res.json();
  if (!data.tracks || data.tracks.items.length === 0) return "N√£o encontrei nada no Spotify üé∂";
  const track = data.tracks.items[0];
  return `üéµ ${track.name} - ${track.artists.map(a => a.name).join(", ")}<br>
  üîó <a href="${track.external_urls.spotify}" target="_blank">Ouvir no Spotify</a><br>
  ${track.preview_url ? "‚ñ∂Ô∏è Preview: <a href='" + track.preview_url + "' target='_blank'>link</a>" : "Sem preview dispon√≠vel"}`;
}

/* ===========================
   Wikipedia
=========================== */
async function wikiSummary(topic) {
  const url = `https://pt.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`;
  const res = await fetch(url, { headers: { "User-Agent": "EVA-Bot/1.0 (https://vennuta-coder.github.io/eva/)" } });
  if (!res.ok) return "N√£o encontrei nada na Wikipedia üìö";
  const data = await res.json();
  return `üìñ <b>${data.title}</b><br>${data.extract}<br>üîó <a href="${data.content_urls.desktop.page}" target="_blank">Ler mais</a>`;
}

/* ===========================
   Chat
=========================== */
function createMessageHtml(sender, text) {
  const alignment = sender === "user" ? "justify-end" : "justify-start";
  const bubbleClass = sender === "user" ? "bubble-user" : "bubble-ai";
  return `<div class="flex ${alignment}">
      <div class="max-w-[85%] p-3 ${bubbleClass}">
        <p>${text}</p>
      </div>
    </div>`;
}

async function sendMessage() {
  const input = document.getElementById("user-input");
  const text = input.value.trim();
  if (!text) return;
  input.value = "";

  const chat = document.getElementById("chat-messages");
  chat.innerHTML += createMessageHtml("user", text);

  let response = null;

  // Wikipedia
  if (text.toLowerCase().startsWith("wikipedia:") || text.toLowerCase().startsWith("quem foi") || text.toLowerCase().startsWith("o que √©")) {
    const topic = text.replace(/wikipedia:|quem foi|o que √©/gi, "").trim();
    response = await wikiSummary(topic);
  }
  // Spotify
  else if (text.toLowerCase().startsWith("procura m√∫sica") || text.toLowerCase().startsWith("spotify")) {
    const song = text.replace(/procura m√∫sica|spotify/gi, "").trim();
    response = await searchSpotifyTrack(song);
  }
  else {
    response = "Ainda n√£o aprendi isso ü§ñ. Tenta pedir uma m√∫sica ou 'Wikipedia: ...'";
  }

  chat.innerHTML += createMessageHtml("ai", response);
  chat.scrollTop = chat.scrollHeight;
}

document.getElementById("send-button").addEventListener("click", sendMessage);
</script>
</body>
</html>
