<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EVA - Assistente Virtual</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f9fafb; }
    .eva-bubble {
      background: #fff7ed;
      border-radius: 1rem;
      border: 2px solid #f97316;
      color: #1f2937;
      box-shadow: 0 0 12px rgba(249, 115, 22, 0.35);
      position: relative;
    }
    .user-bubble {
      background: #0078FF;
      color: white;
      border-radius: 1rem;
    }
    .loader span {
      display: inline-block;
      width: 6px; height: 6px;
      margin: 0 2px; background: #f97316;
      border-radius: 50%;
      animation: bounce 1.4s infinite;
    }
    .loader span:nth-child(2) { animation-delay: 0.2s; }
    .loader span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    footer span {
      text-shadow: 0 0 8px rgba(249, 115, 22, 0.6);
    }
    .logo-glow { filter: drop-shadow(0 0 6px rgba(249, 115, 22, 0.7)); }
    .fade-in { opacity: 0; animation: fadeIn 0.5s forwards; }
    @keyframes fadeIn { to { opacity: 1; } }
    .skip-btn {
      font-size: 10px;
      position: absolute;
      bottom: -16px;
      right: 8px;
      color: #f97316;
      cursor: pointer;
    }
  </style>
</head>
<body class="flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow flex items-center px-4 py-3">
    <img src="assets/logoeva.png" class="h-10 w-10 mr-3 logo-glow">
    <h1 class="text-xl sm:text-2xl font-bold">
      <span style="color:black;">E</span><span style="color:orange;">V</span><span style="color:black;">A</span>
    </h1>
  </header>

  <!-- Chat -->
  <main id="chat-container" class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-4 scroll-smooth">
    <div class="flex items-start space-x-2 fade-in">
      <img src="assets/logoeva.png" class="h-8 w-8 rounded-full logo-glow">
      <div class="eva-bubble p-3 shadow text-sm sm:text-base">
        <p>OlÃ¡! Eu sou a EVA.<br>JÃ¡ vens com choradeira ou com piada?</p>
      </div>
    </div>
  </main>

  <!-- Input -->
  <div class="bg-white border-t p-2 sm:p-3 flex items-center space-x-2 fixed bottom-0 left-0 right-0">
    <textarea id="user-input" rows="1" placeholder="Escreva aqui..."
      class="flex-1 resize-none border rounded-full px-3 py-2 text-sm sm:text-base focus:ring focus:ring-orange-300"></textarea>
    <button id="send-btn"
      class="bg-orange-500 text-white p-3 rounded-full hover:bg-orange-400 flex items-center justify-center">
      <i class="ph-paper-plane-right text-xl"></i>
    </button>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-100 text-center py-2 text-xs sm:text-sm mt-12">
    <span style="color:black;">E</span><span style="color:orange;">V</span><span style="color:black;">A</span> Â© 2025
  </footer>

  <script>
    const GOOGLE_API_KEY = "AIzaSyD3OOOrDwc5KtuiUAzg1Pq2dGGVaRJjU3s";
    const WEATHER_KEY = "7db838cde261492656dc201d1d17e4aa";

    const chatContainer = document.getElementById("chat-container");
    const input = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");

    function scrollToBottom() {
      chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
    }

    function addMessage(sender, text, progressive=false) {
      const wrapper = document.createElement("div");
      wrapper.className = sender === "eva" ? "flex items-start space-x-2 fade-in" : "flex justify-end fade-in";

      if (sender === "eva") {
        const bubble = document.createElement("div");
        bubble.className = "eva-bubble p-3 text-sm sm:text-base relative";
        const avatar = `<img src="assets/logoeva.png" class="h-8 w-8 rounded-full logo-glow">`;
        
        if (progressive) {
          const p = document.createElement("p");
          bubble.appendChild(p);

          const skip = document.createElement("span");
          skip.className = "skip-btn";
          skip.textContent = "Mostrar tudo";
          bubble.appendChild(skip);

          wrapper.innerHTML = avatar;
          wrapper.appendChild(bubble);
          chatContainer.appendChild(wrapper);
          scrollToBottom();

          let words = text.split(" ");
          let index = 0;
          let interval = setInterval(() => {
            if (index < words.length) {
              p.innerHTML += (index > 0 ? " " : "") + words[index];
              index++;
              scrollToBottom();
            } else {
              clearInterval(interval);
              skip.remove();
            }
          }, 150);

          skip.addEventListener("click", () => {
            clearInterval(interval);
            p.innerHTML = text;
            skip.remove();
          });
        } else {
          bubble.innerHTML = `<p>${text}</p>`;
          wrapper.innerHTML = avatar;
          wrapper.appendChild(bubble);
          chatContainer.appendChild(wrapper);
          scrollToBottom();
        }
      } else {
        wrapper.innerHTML = `<div class="user-bubble p-3 shadow max-w-[80%] sm:max-w-xs text-sm sm:text-base">${text}</div>`;
        chatContainer.appendChild(wrapper);
        scrollToBottom();
      }
    }

    async function evaRespond(query) {
      // Clima
      if (/tempo|clima|chuva|frio|calor|graus/i.test(query)) {
        try {
          let city = "Lisboa";
          const match = query.match(/em ([a-zA-ZÃ€-Ã¿]+)/i);
          if (match) city = match[1];

          const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${WEATHER_KEY}&units=metric&lang=pt`;
          const res = await fetch(url);
          const data = await res.json();

          if (data.main) {
            const desc = data.weather[0].description;
            const temp = data.main.temp.toFixed(1);
            addMessage("eva", `O clima em ${city} estÃ¡ com ${desc}, temperatura de ${temp}Â°C.`, true);
            return;
          } else {
            addMessage("eva", "NÃ£o encontrei essa cidade no sistema meteorolÃ³gico.", true);
            return;
          }
        } catch {
          addMessage("eva", "Erro ao buscar o clima.", true);
          return;
        }
      }

      // TraduÃ§Ã£o sob pedido
      if (/traduz|traduza|traduÃ§Ã£o/i.test(query)) {
        const text = query.replace(/traduz(ir)?|traduza|traduÃ§Ã£o/gi, "").trim();
        if (!text) { addMessage("eva", "Diz-me o que queres que traduza ðŸ˜‰", true); return; }

        const target = "en"; // padrÃ£o: traduz para inglÃªs
        try {
          const url = `https://translation.googleapis.com/language/translate/v2?key=${GOOGLE_API_KEY}`;
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ q: text, target })
          });
          const data = await res.json();
          addMessage("eva", `TraduÃ§Ã£o: ${data.data.translations[0].translatedText}`, true);
          return;
        } catch {
          addMessage("eva", "Erro ao traduzir.", true);
          return;
        }
      }

      // Fallback â†’ Google Custom Search
      try {
        const cx = "81b1c6566b6be4ccf"; // teu Custom Search Engine ID
        const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${cx}&q=${encodeURIComponent(query)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.items && data.items.length > 0) {
          const first = data.items[0];
          addMessage("eva", `${first.title} â€” ${first.snippet} (${first.link})`, true);
        } else {
          addMessage("eva", "NÃ£o encontrei nada relevante. Vai ver se estÃ¡ a chover lÃ¡ fora ðŸ˜…", true);
        }
      } catch {
        addMessage("eva", "Erro ao procurar informaÃ§Ã£o online.", true);
      }
    }

    function handleSend() {
      const text = input.value.trim();
      if (!text) return;
      addMessage("user", text);
      input.value = "";
      evaRespond(text);
    }

    sendBtn.addEventListener("click", handleSend);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
  </script>
</body>
</html>
